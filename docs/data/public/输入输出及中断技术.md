## I/O接口要解决的问题

1）速度匹配问题

CPU的速度很高，而外设的速度有高有低

2）信号电平和驱动能力问题

外设需要的电平要比CPU的TTL电平(0~5V)范围要宽

3）信号形式匹配问题

CPU只能处理数字信号

4）信号格式问题

CPU在系统总线转送的是8位，16位或32位并行二进制数据

5）时序匹配问题

CPU的各种操作都是在统一的时钟信号作用下完成的。

## I/O接口的功能

1）I/O地址译码与设备选择

2）信息的输入/输出

3）命令、数据和状态的缓冲与锁存

4）信息转换

5）增加信号的驱动能力

## 端口

CPU与I/O接口进行通信实际上是通过I/O接口内部的一组寄存器实现的，这些寄存器通常称为I/O端口。

3种类型：数据端口、状态端口和命令(或控制)端口

8088/8086CPU最多能管理64K个端口。

### 编址

1）统一编址(或存储器映射编址)

把每个I/O端口都当做一个存储单元看待

优点：

1. 可以用访问内存的方法来访问I/O端口
2. I/O控制信号也可以与存储器的控制信号(指令及控制信号统一)

缺点：

1. 外设占用了一部分内存空间(内存地址资源减少)

2）独立编址

特点：

1. 内存地址空间和外设地址空间是相互独立的(内存地址资源充分利用)
2. I/O端口与内存使用不同的控制信号
3. 指令系统中设置了专门用于访问外设的I/O指令(能够应用于端口的指令减少)

## 接口电路的基本组成

把信息从外部设备送入CPU的接口(端口)叫做输入接口(端口)

将信息从CPU输出到外部设备的接口(端口)叫做输出接口(端口)

输入接口必须要具有对数据的控制能力

输出接口必须要具有对数据的锁存能力

## 基本输入/输出方式

### 无条件传送方式

用于外部控制过程的各种动作固定的，而且是已知的

控制对象是一些简单的、随时“准备好”的外设

### 查询方式

利用程序不断地询问外部设备的状态，根据它们所处的状态来实现数据的输出和输入的方式

外部设备需要向计算机提供一个状态信息，还要有一个传送状态的端口

对传送速率和效率要求不高

大部分的外设并不是总处于“准备好”

要求：

1. 连接到系统的外部设备是简单的、慢速的，且对实时性要求不高
2. 连接到同一系统的外设，其工作速度是相近的。相差太大，可能会造成某些设备的数据丢失

### 中断方式

由外部设备在需要进行数据传送时向CPU发出中断请求，CPU在接到请求后若条件允许，则暂停(或中断)正在进行的工作而转去对该外设服务，并在服务结束后回到原来被中断的地方继续原来的工作。

### 直接存储器存取方式(主存与外设)

希望外设能够不通过CPU而直接与存储器进行信息交换

#### DMA控制器的功能

1）收到接口发出的DMA请求后，DMA控制器向CPU发出请求信号HOLD，请求CPU放弃总线的控制

2）当CPU响应请求并发出响应信号HLDA后，DMA控制器要接管总线的控制权

3）能向地址总线发出内存地址信息，找到相应单元并能够自动修改其地址计数器

4）能向存储器或外设发出读/写命令

5）能决定传送的字节数，并判断DMA传送是否结束

6）在DMA过程结束后，能向CPU发出DMA结束信号，将总线权交还给CPU

注意：

1. 在DMA传送前，CPU必须告诉DMA控制器传送是在哪两个部件之间进行的，传送内存首地址以及传送的字节数是多少
2. 在DMA传送前，DMA只负责送出地址及控制信号，而数据传送是直接在接口和内存间进行的，并不经过DMA控制器

## 中断技术

中断：在微机中，当CPU执行程序过程时，由于随机的事件(包括CPU内部的和外部的事件)引起CPU暂时停止正在执行的程序，而转去执行一个用于处理该事件的程序----称为中断服务程序(或中断处理程序)，处理完后又返回被中止的程序断点处继续执行，这一过程就称为中断。

引起中断的事件就称为中断源

**中断源的分类**

- 内部中断
  - 异常中断 --- 异常中断引起
    - 除法错中断
    - 溢出中断
  - 软件中断 --- 中断指令引起
- 外部中断
  - 可屏蔽中断 --- INTR中断   高电平有效
  - 非屏蔽中断 --- NMI中断  上升沿有效

**引入中断的原因**

1. 提高数据传输效率
2. 避免了CPU不断检测外设状态的过程提高了CPU的利用率。
3. 实现对特殊事件的实时响应

### 中断处理的一般过程

#### 中断请求

CPU能够即时响应的中断可以采用边沿触发，不能即时响应的中断可以采用电平触发

CPU的NMI为上升边沿触发，INTR为高电平触发。

INTR中断请求信号应保持到该请求被CPU响应为止，CPU响应后，INTR应及时撤销

#### 中断源识别(中断判优)

1）软件判优

优点：

1. 硬件电路简单
2. 优先权安排灵活

缺点：

1. 判优时间较长，会影响到中断响应的实时性

2）硬件判优

① 中断控制器判优

根据中断向量码来确定中断源

② 链式判优

将所有的中断源构成一个链，排在链前面的中断源的优于后面的

3）中断嵌套问题

每次嵌套都要用堆栈来保护断点，嵌套较多时，会产生溢出

#### 中断响应

要求：

1. 一条指令执行结束
2. CPU处于开中断状态
3. 当前没有发生复位(RESET)、保持(HOLD)、内部中断和非屏蔽中断请求(NMI)
4. 当前执行的指令是开中断指令(STI)和中断返回指令IRET

工作：

1. 保护硬件现场，即FLAGS(PSW)
2. 保护断点。压入CS,IP
3. 获得中断服务程序入口

#### 中断处理

工作：

1. 保护软件现场。把用到的寄存器压入堆栈
2. 开中断
3. 执行中断处理程序
4. 关中断
5. 恢复现场

#### 中断返回

需要执行中断返回指令IRET

## 可编程中断控制器8259A [百度百科](https://baike.baidu.com/item/8259A/11048399?fr=aladdin)

### 引脚

1）D~0~ ~ D ~7~ 为双向数据线，编程控制字、命令字写入，中断向量码送给CPU

2）$\overline{WR}、\overline{RD}$ 为写和读控制字信号

3）$\overline{CS}$ 为片选信号

4）A~0~ 是8289A内部寄存器的选择信号。

5）INT 为8289A的中断请求输出信号

6）$\overline{INTA}$ 为中断响应输出信号

7）CAS~0~ ~ CAS~2~ 为级联控制线

级联时，主片为输出，从片为输入

8）$\overline{SP}/\overline{EN}$ 为双向功能引线

①缓冲模式

输出，控制缓冲器的传送方向

高电平：CPU送入8289A

②非缓冲模式

高电平：主片

低电平：从片

9）IR~0~ ~ IR~7~ 为中断请求输入信号

### 内部结构  

1）中断请求寄存器 IRR

2）中断服务寄存器 ISR

3）中断屏蔽寄存器 IMR

4）中断判优电路PR

5) 数据总线缓冲器

6）读/写控制逻辑

7）级联缓冲器/比较器

### 工作过程

1）若有一条或若干条中断请求输入线(IR~0~ ~ IR~7~)上的中断请求信号有效，则IRR的相应位置置一。

2）若中断请求线中至少有一条是中断未被屏蔽的，则8259A由INT引脚向CPU对INTR的响应。

3）若CPU是处于开中断状态，则在当前指令执行完后，CPU用$\overline{INTA}$信号作为对INTR的响应

4）8259A在接收到CPU发出的第一个$\overline{INTA}$脉冲，8259A把选中的中断源所对应的8位中断类型码放到数据总线上，CPU读取并乘以4，得到中断服务子程序的入口地址并转去执行

6）若8259A工作在自动中断结束AEOI方式，在第二个$\overline{INTA}$脉冲结束时，就会使中断源所对应的ISR中的相应位复位。对于非自动中断结束方式，则由CPU在中断服务子程序结束时向8259A写入EOI命令，才使ISR中的相应位复位。

### 工作方式

#### 1. 中断优先方式与中断嵌套

1）中断优先方式

① 固定优先级方式

② 循环优先级方式

2）中断嵌套

① 普通全嵌套方式

② 特殊全嵌套方式

#### 2. 中断结束处理方式

对级联使用的8259A都必须发两次中断结束命令，一次是发给主片的，另一次则是发给从片的。

1）自动中断结束方式

2）正常中断结束方式

3）特殊中断结束方式

#### 3. 屏蔽中断源的方式

1）普通屏蔽方式

2）特殊屏蔽方式

#### 4. 中断触发方式

1）边沿触发方式

2）电平触发方式

#### 5. 级联方式

pass

### 初始化编程

控制命令分为初始化命令字ICW和操作命令字OCW

步骤：

1. 初始化编程：由CPU向8259A送2 ~ 4个字节的初始化命令字ICW。在8259A工作之前，必须写入初始化命令字使其处于准备就绪状态。
2. 操作方式编程：由CPU向8259A送3个字节的操作命令字OCW，以规定8259A的操作方式。OCW可在8259A初始化后的任何时刻写入。

内部寄存器的寻址方法

<table>
    <tr>
        <th>CS#</th>
        <th>RD#</th>
        <th>WR#</th>
        <th>A<sub>0</sub></th>
        <th>D<sub>4</sub></th>
        <th>D<sub>3</sub></th>
        <th>读写操作</th>
    </tr>
    <tr>
        <td rowspan="4">0</td>
        <td rowspan="4">1</td>
        <td rowspan="4">0</td>
        <td>0</td>
        <td>0</td>
        <td>0</td>
        <td>写入OCW2</td>
    </tr>
    <tr>
        <td>0</td>
        <td>0</td>
        <td>1</td>
        <td>写入OCW3</td>
    </tr>
    <tr>
        <td>0</td>
        <td>1</td>
        <td>*</td>
        <td>写入ICW1</td>
    </tr>
    <tr>
        <td>1</td>
        <td>*</td>
        <td>*</td>
        <td>写入ICW2、ICW3、ICW4、OCW1(顺序写入)</td>
    </tr>
    <tr>
        <td rowspan="2">0</td>
        <td rowspan="2">0</td>
        <td rowspan="2">1</td>
        <td>0</td>
        <td>-</td>
        <td>-</td>
        <td>读出IRR、ISR</td>
    </tr>
    <tr>
        <td>1</td>
        <td>-</td>
        <td>-</td>
        <td>读出IMR</td>
    </tr>
</table>



#### 2. 8259A的初始化顺序

写ICW --> 写ICW2 --> 级联？ --Y--> 写ICW3 --> 需ICW4？ --Y--> 写ICW4 --> 结束

++++++++++++++++++|-------------------N------------->|------------------N------------>

#### 8259A的内部控制字

**1）初始化命令字ICW**

(1) **ICW1 --- 初始化字**

写条件：

A~0~ = 0, D~4~ = 1

工作：

① 清除ISR和IMR

② 将中断优先级设为初始状态：IR~0~(最高)，IR~7~（最低）

③ 设定为普通屏蔽方式

④ 采用非自动EOI中断结束方式。

⑤ 状态读出电路预置为读IRR。

位：

D~7~ \D~6~\D~5~\D~2~：*

D~4~特征位：1

D~3~：LTIM

- 1 IR~0~ ~ IR~7~高电平触发
- 0 IR~0~ ~ IR~7~上升沿触发

D~1~：SNGL

- 1 单片8259A
- 0 多片级联

D~0~：IC~4~

- 1 要写ICW4
- 0 不写ICW4(默认为全零)

(2) **ICW2 --- 中断向量码**

条件：

A~0~ = 1

位：

D~7~ ~ D~3~：中断向量码高五位

D~2~ ~ D~0~：中断源序号

(3) **ICW3 --- 级联控制字**

紧跟着ICW2写入同一个I/O地址。

条件：

A~0~ = 1

①主片级联控制字

D~7~ ~ D~0~：

- 1 对应IR线上连接了从片
- 0 对应IR线上没有连接从片

② 从片级联控制字

D~7~ ~ D~3~：0

D~2~ ~ D~0~：从片标识码

- 000 --- IR~0~
- ...
- 111 --- IR~7~

(4) **ICW4 --- 中断结束方式字**

紧跟着ICW3写入同一个I/O地址。

条件：

A~0~ = 1

位：

D~7~ ~ D~5~：0

D~4~：SFNM

- 1 特殊嵌套

- 0 一般嵌套

D~3~、D~2~：BUF、M/S

- 0X 非缓冲方式
- 10 缓冲方式 --- 主片
- 11 缓冲方式 --- 从片

D~1~：AEOI

- 1 自动EOI
- 0 非自动EOI

D~0~：0

**2）操作命令字OCW**

(1) **OCW1 --- 中断屏蔽字**

条件：

A~0~ = 1

位：

D~7~ ~ D~0~：

- 1 屏蔽
- 0 允许中断

(2) **OCW2 --- 中断结束和优先级循环**

对8259A发出中断结束命令EOI，控制中断优先级的循环。

与OCW3共用一个端口地址

条件：

A~0~ = 0

位：

D~7~ ~ D~5~：R、SL、EOI

- 001 一般EOI命令，全嵌套方式。
- 011 特殊EOI命令，全嵌套方式，按L~2~ ~ L~0~编码复位ISR。
- 101 一般EOI命令，优先级自动循环。
- 100 在自动EOI时设置优先级自动循环
- 000 在自动EOI时取消优先级自动循环
- 111 一般EOI命令，按L~2~ ~ L~0~ 编码循环优先级(L~2~ ~ L~0~为最低优先级)
- 110 按L~2~ ~ L~0~编码循环优先级(L~2~ ~ L~0~为最低优先级）

D~4~ ~ D~3~：特征位 0

D~2~ ~ D~0~：L~2~、L~1~、L~0~

- 中断优先级别：0 ~ 7 或 ISR的位号：0 ~ 7

① R：优先级循环控制位。

- 0 使用固定优先级，IR~0~ 最高，IR~7~最低
- 1 使用循环优先级，一个中断服务结束后，它的优先级就变成最低。

② SL：特殊循环控制。

- 0 L~2~ ~ L~0~ 的编码无效
- 1 使L~2~ ~ L~0~ 对应的IR~i~ 为最低优先级

③ EOI：中断结束命令。

- 1 复位现行中断的ISR中的相应位，以便允许8259A再为其他中断源服务。
- 在ICW4 的 AEOI = 0 (非自动EOI)的情况下，需要用OCW2来复位现行中断的ISR中的相应位。

④ L~2~ ~ L~0~：

- 设定哪个IR~i~优先级最低
- 在特殊中断结束命令中指明ISR哪一位要被复位。

(3) **OCW3 --- 屏蔽方式和状态读出控制字** 

功能：

1. 设置中断屏蔽方式

2. 查询中断请求。当CPU禁止中断或不希望8259A向CPU申请中断时，就可以采用8259A的查询工作方式，CPU先写一个P = 1的OCW3到8259A，在对同一地址读入，即可得到（查询结果）所示格式的状态字节。

3. 读8289A状态。可用OCW3命令控制读出IRR、ISR和IMR的内容，当A0 = 1(奇地址)时读出IMR的内容(不依赖于OCW3)

条件：

A~0~ = 0

位：

D~7~：*

D~6~ ~ D~5~：ESMM、SMM

- 10 清除特殊屏蔽
- 11 设置特殊屏蔽

D~4~ ~ D~3~：特征位 01

D~2~: P

- 0 非查询方式
- 1 查询方式

D~1~ ~ D~0~：RR、RIS

- 10 随后读IRR
- 11 随后读ISR

**状态查询结果**

I * * * * R~2~ R~1~ R~0~

#### 例子

1）8259A初始化编程

；主片8259A的初始化

MOV AL，11H

OUT 20H, AL

JMP INTR1

INTR1:MOV AL，08H

OUT 21H, AL

JMP INTR2

INTR2:MOV AL, 04H

OUT 21H, AL

JMP INTR3

INTR3:MOV AL，11H

OUT 21H, AL

...

;从片8259A的初始化

MOV AL, 11H

OUT 0A0H, AL

JMP INTR5

INTR5:MOV AL，70H

OUT 0A1H, AL

JMP INTR6

INTR6:MOV AL, 02H

OUT 0A1H, AL

JMP INTR7

INTR7:MOV AL, 01H

OUT 0A1H, AL

...

2)级联工作编程

；读ISR的内容

MOV AL, 0BH

OUT 0A0H, AL

NOP

IN AL, 0A0H

...

;向从片发出EOI命令

MOV AL, 20H

OUT 0A0H, AL

...

;向主片发出EOI命令

MOV AL, 20H

OUT 20H, AL

...

